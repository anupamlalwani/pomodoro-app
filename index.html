<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Timer</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center;
            transition: background-color 0.5s ease-in-out, background-image 0.5s ease-in-out;
            min-height: 100vh;
            color: #f9fafb;
            background-color: #111827;
            overflow-x: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .timer-display { font-variant-numeric: tabular-nums; }
        .glass-panel {
            background-color: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        input, select {
            background-color: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.75rem;
            border-radius: 0.75rem;
        }
        input:focus, select:focus { border-color: #3b82f6; outline: none; }
        button:active { transform: scale(0.96); }
    </style>
</head>
<body class="p-4">
    
    <div class="w-full max-w-md relative z-10">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold tracking-tight opacity-90">Focus Timer</h1>
        </div>

        <!-- Timer Circle -->
        <div class="glass-panel p-10 rounded-full w-72 h-72 sm:w-80 sm:h-80 mx-auto flex flex-col items-center justify-center shadow-2xl mb-8 border border-white/10">
            <p id="mode-display" class="text-sm font-bold uppercase tracking-widest text-blue-400 mb-2">Ready</p>
            <p id="timer-display" class="text-6xl sm:text-7xl font-bold timer-display">25:00</p>
        </div>

        <!-- Manual Timer Controls -->
        <div id="manual-controls" class="space-y-4 mb-8">
            <div class="flex items-center justify-center space-x-3">
                 <input type="number" id="time-input" class="w-24 text-center text-xl font-semibold" value="25">
                 <span class="text-lg opacity-70 font-medium">min</span>
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="start-focus-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-2xl transition-all shadow-lg flex-1">Start Focus</button>
                <button id="start-break-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 px-8 rounded-2xl transition-all shadow-lg flex-1">Break</button>
            </div>
        </div>
        
        <div id="active-controls" class="hidden text-center mb-8">
             <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-16 rounded-2xl transition-all shadow-lg">Stop Session</button>
        </div>
        
        <!-- Settings Panel -->
        <div class="glass-panel p-6 rounded-3xl shadow-xl space-y-5">
            <h2 class="text-lg font-semibold opacity-80 border-b border-white/10 pb-2">Ambience & Alerts</h2>
            
            <div class="flex items-center justify-between gap-4">
                <label class="text-sm font-medium opacity-70">Alarm Sound</label>
                <div class="flex items-center space-x-2">
                    <select id="alarm-sound" class="text-sm w-36">
                        <option value="beep">Digital Beep</option>
                        <option value="bell">Temple Bell</option>
                        <option value="chime">Crystal Chime</option>
                    </select>
                    <button id="preview-alarm-btn" class="text-xl">▶️</button>
                </div>
            </div>

            <div class="flex items-center justify-between gap-4">
                <label class="text-sm font-medium opacity-70">Focus Audio</label>
                <div class="flex items-center space-x-2">
                    <select id="focus-sound" class="text-sm w-36">
                        <option value="none">None</option>
                        <option value="binaural">Binaural Beats</option>
                        <option value="isochronic">Isochronic Tones</option>
                        <option value="ocean">Ocean Waves</option>
                    </select>
                    <button id="preview-focus-btn" class="text-xl">▶️</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- PERSISTENT AUDIO & STEALTH WAKE ---
        window.audioSystem = {
            ctx: null,
            master: null,
            nodes: [],
            oceanBuffer: null,
            wakeLock: null,
            keepAliveOsc: null
        };

        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    // Silent acquisition (removed UI indicator)
                    window.audioSystem.wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    console.warn('Wake Lock request failed');
                }
            }
        }

        function releaseWakeLock() {
            if (window.audioSystem.wakeLock !== null) {
                window.audioSystem.wakeLock.release();
                window.audioSystem.wakeLock = null;
            }
        }

        function getCtx() {
            if (!window.audioSystem.ctx) {
                window.audioSystem.ctx = new (window.AudioContext || window.webkitAudioContext)({
                    latencyHint: 'playback'
                });
            }
            if (window.audioSystem.ctx.state === 'suspended') {
                window.audioSystem.ctx.resume();
            }
            return window.audioSystem.ctx;
        }

        // Stealth Keep-Alive: Signals to the OS that audio is playing to prevent process death
        function startKeepAlive() {
            const ctx = getCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = 21000; // Ultrasonic frequency (inaudible to most adults)
            gain.gain.value = 0.001; // Extremely low volume
            osc.connect(gain).connect(ctx.destination);
            osc.start();
            window.audioSystem.keepAliveOsc = { osc, gain };
        }

        function stopKeepAlive() {
            if (window.audioSystem.keepAliveOsc) {
                try {
                    window.audioSystem.keepAliveOsc.osc.stop();
                    window.audioSystem.keepAliveOsc.osc.disconnect();
                } catch(e) {}
                window.audioSystem.keepAliveOsc = null;
            }
        }

        function getOceanBuffer(ctx) {
            if (window.audioSystem.oceanBuffer) return window.audioSystem.oceanBuffer;
            const bufferSize = 10 * ctx.sampleRate;
            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
            const data = buffer.getChannelData(0);
            let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
            for (let i = 0; i < bufferSize; i++) {
                let white = Math.random() * 2 - 1;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.12;
                b6 = white * 0.115926;
            }
            window.audioSystem.oceanBuffer = buffer;
            return buffer;
        }

        function playAlarm(type) {
            const ctx = getCtx();
            const now = ctx.currentTime;
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(0.9, now);
            gain.connect(ctx.destination);
            if (type === 'beep') {
                const osc = ctx.createOscillator(); osc.frequency.value = 880; osc.connect(gain);
                osc.start(now); osc.stop(now + 0.5);
            } else if (type === 'bell') {
                const osc = ctx.createOscillator(); osc.type = 'sine'; osc.frequency.value = 440;
                const ig = ctx.createGain(); osc.connect(ig).connect(gain);
                ig.gain.setValueAtTime(0.6, now); ig.gain.exponentialRampToValueAtTime(0.001, now + 3);
                osc.start(now); osc.stop(now + 3);
            } else {
                [1318.51, 1648.14, 1975.53].forEach((f, i) => {
                    const osc = ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.value = f;
                    const g = ctx.createGain(); osc.connect(g).connect(gain);
                    g.gain.setValueAtTime(0, now + (i*0.1)); g.gain.linearRampToValueAtTime(0.4, now + (i*0.1) + 0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, now + 2); osc.start(now + (i*0.1)); osc.stop(now + 2);
                });
            }
        }

        function stopFocus() {
            window.audioSystem.nodes.forEach(n => { try { n.stop(); n.disconnect(); } catch(e) {} });
            window.audioSystem.nodes = [];
            if (window.audioSystem.master) { window.audioSystem.master.disconnect(); window.audioSystem.master = null; }
            stopKeepAlive();
        }

        function playFocus(type) {
            stopFocus();
            startKeepAlive(); // Trigger OS keep-alive
            if (type === 'none') return;
            const ctx = getCtx();
            const master = ctx.createGain(); master.gain.value = 0.8; master.connect(ctx.destination);
            window.audioSystem.master = master;
            const nodes = [];
            if (type === 'binaural') {
                const merger = ctx.createChannelMerger(2); merger.connect(master);
                const l = ctx.createOscillator(); l.frequency.value = 180; l.connect(merger, 0, 0);
                const r = ctx.createOscillator(); r.frequency.value = 186; r.connect(merger, 0, 1);
                l.start(); r.start(); nodes.push(l, r, merger);
            } else if (type === 'isochronic') {
                const osc = ctx.createOscillator(); osc.type = 'sine'; osc.frequency.value = 160;
                const mod = ctx.createGain();
                const lfo = ctx.createOscillator(); lfo.type = 'square'; lfo.frequency.value = 4;
                lfo.connect(mod.gain); osc.connect(mod).connect(master);
                osc.start(); lfo.start(); nodes.push(osc, lfo, mod);
            } else if (type === 'ocean') {
                const src = ctx.createBufferSource(); src.buffer = getOceanBuffer(ctx); src.loop = true;
                const filter = ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 600;
                const g = ctx.createGain();
                const lfo = ctx.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.1;
                const lfoGain = ctx.createGain(); lfoGain.gain.value = 0.3; lfo.connect(lfoGain).connect(g.gain);
                g.gain.value = 0.5;
                src.connect(filter).connect(g).connect(master);
                src.start(); lfo.start(); nodes.push(src, filter, g, lfo, lfoGain);
            }
            window.audioSystem.nodes = nodes;
        }

        const images = [
            'https://images.unsplash.com/photo-1557682250-33bd709cbe85?q=80&w=2070',
            'https://images.unsplash.com/photo-1502691876148-a84978e59af8?q=80&w=2070',
            'https://images.unsplash.com/photo-1528459801416-a9e53bbf4e17?q=80&w=1912',
            'https://images.unsplash.com/photo-1536924940846-227afb31e2a5?q=80&w=2066',
            'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80&w=2070'
        ];
        
        function setBG(mode) {
            if (mode === 'Focus' || mode === 'Break') {
                const url = images[Math.floor(Math.random() * images.length)];
                document.body.style.backgroundImage = `url('${url}')`;
            } else {
                document.body.style.backgroundImage = 'none'; document.body.style.backgroundColor = '#111827';
            }
        }

        const display = document.getElementById('timer-display');
        const modeLabel = document.getElementById('mode-display');
        const input = document.getElementById('time-input');
        const sFocus = document.getElementById('start-focus-btn');
        const sBreak = document.getElementById('start-break-btn');
        const stopBtn = document.getElementById('stop-btn');
        const manual = document.getElementById('manual-controls');
        const active = document.getElementById('active-controls');
        const alarmSelect = document.getElementById('alarm-sound');
        const focusSelect = document.getElementById('focus-sound');

        let ticker, running = false, left, mode = 'Ready', endTime;

        function updateDisplay() {
            const m = Math.floor(left / 60);
            const s = left % 60;
            const timeStr = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            display.textContent = timeStr;
            document.title = `${timeStr} - ${mode}`;
        }

        function start(duration, m) {
            if (running) return;
            getCtx();
            requestWakeLock();
            
            mode = m; 
            left = duration * 60; 
            endTime = Date.now() + (left * 1000);
            running = true;
            
            setBG(mode); modeLabel.textContent = mode; updateDisplay();
            manual.classList.add('hidden'); active.classList.remove('hidden');
            
            // Start audio immediately to link it to the user gesture
            playFocus(focusSelect.value);

            ticker = setInterval(() => {
                const now = Date.now();
                left = Math.ceil((endTime - now) / 1000);
                
                if (left <= 0) {
                    left = 0;
                    updateDisplay();
                    end(true);
                } else {
                    updateDisplay();
                }
            }, 500);
        }

        function end(isAlarm = false) {
            if (!running) return;
            clearInterval(ticker); running = false;
            stopFocus();
            releaseWakeLock();
            
            if (isAlarm) playAlarm(alarmSelect.value);
            mode = 'Ready'; setBG(mode); modeLabel.textContent = 'Ready'; 
            left = (parseInt(input.value) || 25) * 60; updateDisplay();
            manual.classList.remove('hidden'); active.classList.add('hidden');
        }

        sFocus.onclick = () => start(parseInt(input.value) || 25, 'Focus');
        sBreak.onclick = () => start(parseInt(input.value) || 5, 'Break');
        stopBtn.onclick = () => end(false);

        document.getElementById('preview-alarm-btn').onclick = () => { getCtx(); playAlarm(alarmSelect.value); };
        document.getElementById('preview-focus-btn').onclick = () => { getCtx(); playFocus(focusSelect.value); };

        window.addEventListener('load', () => {
            const saved = localStorage.getItem('pomSettings');
            if (saved) {
                const s = JSON.parse(saved);
                input.value = s.time; alarmSelect.value = s.alarm; focusSelect.value = s.focus;
                left = (parseInt(s.time) || 25) * 60; updateDisplay();
            }
        });
        const save = () => localStorage.setItem('pomSettings', JSON.stringify({
            time: input.value, alarm: alarmSelect.value, focus: focusSelect.value
        }));
        input.onchange = save; alarmSelect.onchange = save; focusSelect.onchange = save;

        // Auto-reacquire wake lock on tab return
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && running) {
                requestWakeLock();
            }
        });

        if ('serviceWorker' in navigator && (location.protocol === 'http:' || location.protocol === 'https:')) {
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
        }
    </script>
</body>
</html>